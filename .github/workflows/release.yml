name: Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-release:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - name: Verify Signing Secrets
        run: |
          if [[ -z "${{ secrets.MACOS_SIGNING_CERT_P12_BASE64 }}" ]]; then
            echo "Missing MACOS_SIGNING_CERT_P12_BASE64."
            exit 2
          fi
          if [[ -z "${{ secrets.MACOS_SIGNING_CERT_PASSWORD }}" ]]; then
            echo "Missing MACOS_SIGNING_CERT_PASSWORD."
            exit 2
          fi
          if [[ -z "${{ secrets.MACOS_KEYCHAIN_PASSWORD }}" ]]; then
            echo "Missing MACOS_KEYCHAIN_PASSWORD."
            exit 2
          fi
          if [[ -z "${{ secrets.CODESIGN_IDENTITY }}" ]]; then
            echo "Missing CODESIGN_IDENTITY."
            exit 2
          fi
      - name: Install Signing Certificate
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/ci-signing.keychain-db"
          echo "${{ secrets.MACOS_SIGNING_CERT_P12_BASE64 }}" | base64 --decode > "$RUNNER_TEMP/signing-cert.p12"
          security create-keychain -p "${{ secrets.MACOS_KEYCHAIN_PASSWORD }}" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "${{ secrets.MACOS_KEYCHAIN_PASSWORD }}" "$KEYCHAIN_PATH"
          security import "$RUNNER_TEMP/signing-cert.p12" -k "$KEYCHAIN_PATH" -P "${{ secrets.MACOS_SIGNING_CERT_PASSWORD }}" -T /usr/bin/codesign
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.MACOS_KEYCHAIN_PASSWORD }}" "$KEYCHAIN_PATH"
      - name: Swift Version
        run: swift --version

      - name: Resolve Version
        id: version
        if: github.event_name == 'release'
        run: |
          RAW_TAG="${{ github.event.release.tag_name }}"
          VERSION="${RAW_TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      - name: Build Package
        run: ./scripts/build_pkg.sh
        env:
          TEXT_POLISH_VERSION: ${{ steps.version.outputs.version }}
          TEXT_POLISH_BUILD: ${{ github.run_number }}
          SPARKLE_PUBLIC_KEY: ${{ vars.SPARKLE_PUBLIC_KEY }}
          SPARKLE_REQUIRE_PUBLIC_KEY: 1
          SPARKLE_FEED_URL: https://github.com/${{ github.repository }}/releases/latest/download/appcast.xml
          CODESIGN_IDENTITY: ${{ secrets.CODESIGN_IDENTITY }}
      - name: Package App Bundle
        run: |
          ditto -c -k --sequesterRsrc --keepParent build/TextPolish.app build/TextPolish.app.zip
      - name: Prepare Update Archive
        run: |
          mkdir -p build/updates
          /bin/cp build/TextPolish.app.zip build/updates/TextPolish.app.zip
      - name: Generate Appcast
        run: ./scripts/sparkle_generate_appcast.sh build/updates build/appcast.xml
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
          SPARKLE_DOWNLOAD_URL_PREFIX: https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/
      - name: Generate SBOM
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a
        with:
          path: .
          format: spdx-json
          output-file: build/sbom.spdx.json
      - name: Generate Checksums
        run: |
          shasum -a 256 build/TextPolish.app.zip build/TextPolish.pkg build/appcast.xml build/sbom.spdx.json > build/checksums.txt
      - name: Upload Release Assets
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          files: |
            build/TextPolish.app.zip
            build/TextPolish.pkg
            build/appcast.xml
            build/sbom.spdx.json
            build/checksums.txt
      - name: Update Homebrew Tap
        if: github.event_name == 'release'
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          echo "üîß Starting Homebrew tap update for version ${VERSION}"

          # Calculate local SHA256
          echo "üìä Calculating SHA256 of local build..."
          LOCAL_SHA256=$(shasum -a 256 build/TextPolish.app.zip | awk '{print $1}')
          echo "   Local SHA256: $LOCAL_SHA256"

          # Verify release asset exists and get SHA256
          echo "üîç Verifying release asset..."
          ASSET_URL="https://github.com/kxxil01/TextPolish/releases/download/${VERSION}/TextPolish.app.zip"
          echo "   Asset URL: $ASSET_URL"

          # Check if asset exists
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "${ASSET_URL}")
          if [ "$HTTP_STATUS" != "200" ]; then
            echo "‚ùå ERROR: Release asset not found (HTTP $HTTP_STATUS)"
            echo "   URL: ${ASSET_URL}"
            echo "üîß Please verify the release was uploaded correctly"
            exit 1
          fi
          echo "‚úÖ Release asset exists (HTTP $HTTP_STATUS)"

          # Download and verify SHA256
          echo "üîí Downloading release asset to verify SHA256..."
          RELEASE_SHA256=$(curl -sL --retry 3 --retry-all-errors "${ASSET_URL}" | shasum -a 256 | awk '{print $1}')
          echo "   Release SHA256: $RELEASE_SHA256"

          # Compare SHA256s
          if [ "$LOCAL_SHA256" != "$RELEASE_SHA256" ]; then
            echo "‚ùå ERROR: SHA256 mismatch!"
            echo "   Local:   $LOCAL_SHA256"
            echo "   Release: $RELEASE_SHA256"
            echo "üîß Please verify the build and release process"
            exit 1
          fi
          echo "‚úÖ SHA256 verified - Release asset is valid"

          # Clone tap repository
          echo "üì• Cloning homebrew-tap repository..."
          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/kxxil01/homebrew-tap.git /tmp/homebrew-tap
          cd /tmp/homebrew-tap

          # Create branch for update
          BRANCH_NAME="homebrew-update-${VERSION}"
          echo "üåø Creating branch: $BRANCH_NAME"
          git checkout -b "$BRANCH_NAME"

          # Generate cask file
          echo "üìù Generating updated cask file..."
          cat > Casks/textpolish.rb << 'CASK_EOF'
          cask "textpolish" do
            version "VERSION_PLACEHOLDER"
            sha256 "SHA256_PLACEHOLDER"

            url "https://github.com/kxxil01/TextPolish/releases/download/VERSION_PLACEHOLDER/TextPolish.app.zip"
            name "TextPolish"
            desc "Grammar correction anywhere on macOS"
            homepage "https://github.com/kxxil01/TextPolish"

            depends_on macos: ">= :sonoma"

            app "TextPolish.app"

            zap trash: [
              "~/Library/Application Support/TextPolish",
              "~/Library/Preferences/com.kxxil01.TextPolish.plist",
            ]
          end
          CASK_EOF

          # Replace placeholders
          sed -i '' "s/VERSION_PLACEHOLDER/${VERSION}/g" Casks/textpolish.rb
          sed -i '' "s/SHA256_PLACEHOLDER/${LOCAL_SHA256}/g" Casks/textpolish.rb

          # Verify file was updated
          if ! grep -q "version \"${VERSION}\"" Casks/textpolish.rb; then
            echo "‚ùå ERROR: Failed to update cask file"
            exit 1
          fi

          if ! grep -q "sha256 \"${LOCAL_SHA256}\"" Casks/textpolish.rb; then
            echo "‚ùå ERROR: Failed to update SHA256 in cask file"
            exit 1
          fi

          echo "‚úÖ Casks/textpolish.rb updated successfully"
          echo "üìÑ Version: ${VERSION}"
          echo "üìÑ SHA256: ${LOCAL_SHA256}"

          # Commit changes
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/textpolish.rb

          # Check if there are changes to commit
          if ! git diff --cached --quiet; then
            echo "üìù Committing changes..."
            git commit -m "Update TextPolish to v${VERSION}"

            # Push branch
            echo "üì§ Pushing changes..."
            git push -u origin "$BRANCH_NAME"

            # Create PR
            echo "üîÑ Creating Pull Request..."
            PR_TITLE="Update TextPolish to v${VERSION}"
            PR_BODY="Automated Homebrew tap update for TextPolish v${VERSION}"

            gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base main \
              --head "$BRANCH_NAME" \
              --repo kxxil01/homebrew-tap

            echo "‚úÖ Pull request created successfully"
            echo "üîó Please review and merge the PR at: https://github.com/kxxil01/homebrew-tap/pulls"
          else
            echo "‚ÑπÔ∏è  No changes to commit (cask file already up to date)"
          fi

          echo "üéâ Homebrew tap update completed successfully!"
