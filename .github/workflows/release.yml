name: Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  build-release:
    runs-on: macos-14
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
      - name: Verify Signing Secrets
        run: |
          if [[ -z "${{ secrets.MACOS_SIGNING_CERT_P12_BASE64 }}" ]]; then
            echo "Missing MACOS_SIGNING_CERT_P12_BASE64."
            exit 2
          fi
          if [[ -z "${{ secrets.MACOS_SIGNING_CERT_PASSWORD }}" ]]; then
            echo "Missing MACOS_SIGNING_CERT_PASSWORD."
            exit 2
          fi
          if [[ -z "${{ secrets.MACOS_KEYCHAIN_PASSWORD }}" ]]; then
            echo "Missing MACOS_KEYCHAIN_PASSWORD."
            exit 2
          fi
          if [[ -z "${{ secrets.CODESIGN_IDENTITY }}" ]]; then
            echo "Missing CODESIGN_IDENTITY."
            exit 2
          fi
      - name: Install Signing Certificate
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/ci-signing.keychain-db"
          echo "${{ secrets.MACOS_SIGNING_CERT_P12_BASE64 }}" | base64 --decode > "$RUNNER_TEMP/signing-cert.p12"
          security create-keychain -p "${{ secrets.MACOS_KEYCHAIN_PASSWORD }}" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "${{ secrets.MACOS_KEYCHAIN_PASSWORD }}" "$KEYCHAIN_PATH"
          security import "$RUNNER_TEMP/signing-cert.p12" -k "$KEYCHAIN_PATH" -P "${{ secrets.MACOS_SIGNING_CERT_PASSWORD }}" -T /usr/bin/codesign
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${{ secrets.MACOS_KEYCHAIN_PASSWORD }}" "$KEYCHAIN_PATH"
      - name: Swift Version
        run: swift --version
      - name: Run Tests
        run: swift test
      - name: Resolve Version
        id: version
        if: github.event_name == 'release'
        run: |
          RAW_TAG="${{ github.event.release.tag_name }}"
          VERSION="${RAW_TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
      - name: Build Package
        run: ./scripts/build_pkg.sh
        env:
          TEXT_POLISH_VERSION: ${{ steps.version.outputs.version }}
          TEXT_POLISH_BUILD: ${{ github.run_number }}
          SPARKLE_PUBLIC_KEY: ${{ vars.SPARKLE_PUBLIC_KEY }}
          SPARKLE_REQUIRE_PUBLIC_KEY: 1
          SPARKLE_FEED_URL: https://github.com/${{ github.repository }}/releases/latest/download/appcast.xml
          CODESIGN_IDENTITY: ${{ secrets.CODESIGN_IDENTITY }}
      - name: Package App Bundle
        run: |
          ditto -c -k --sequesterRsrc --keepParent build/TextPolish.app build/TextPolish.app.zip
      - name: Prepare Update Archive
        run: |
          mkdir -p build/updates
          /bin/cp build/TextPolish.app.zip build/updates/TextPolish.app.zip
      - name: Generate Appcast
        run: ./scripts/sparkle_generate_appcast.sh build/updates build/appcast.xml
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
          SPARKLE_DOWNLOAD_URL_PREFIX: https://github.com/${{ github.repository }}/releases/download/${{ github.event.release.tag_name }}/
      - name: Generate SBOM
        uses: anchore/sbom-action@a930d0ac434e3182448fe678398ba5713717112a
        with:
          path: .
          format: spdx-json
          output-file: build/sbom.spdx.json
      - name: Generate Checksums
        run: |
          shasum -a 256 build/TextPolish.app.zip build/TextPolish.pkg build/appcast.xml build/sbom.spdx.json > build/checksums.txt
      - name: Upload Release Assets
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          files: |
            build/TextPolish.app.zip
            build/TextPolish.pkg
            build/appcast.xml
            build/sbom.spdx.json
            build/checksums.txt
      - name: Update Homebrew Tap
        if: github.event_name == 'release'
        env:
          HOMEBREW_TAP_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          SHA256=$(shasum -a 256 build/TextPolish.app.zip | awk '{print $1}')

          git clone https://x-access-token:${HOMEBREW_TAP_TOKEN}@github.com/kxxil01/homebrew-tap.git /tmp/homebrew-tap
          cd /tmp/homebrew-tap

          cat > Casks/textpolish.rb << EOF
          cask "textpolish" do
            version "${VERSION}"
            sha256 "${SHA256}"

            url "https://github.com/kxxil01/TextPolish/releases/download/v#{version}/TextPolish.app.zip"
            name "TextPolish"
            desc "Grammar correction anywhere on macOS"
            homepage "https://github.com/kxxil01/TextPolish"

            depends_on macos: ">= :sonoma"

            app "TextPolish.app"

            zap trash: [
              "~/Library/Application Support/TextPolish",
              "~/Library/Preferences/com.kxxil01.TextPolish.plist",
            ]
          end
          EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/textpolish.rb
          git commit -m "Update TextPolish to v${VERSION}"
          git push
